<?php

declare(strict_types=1);

namespace Phico\Database\Connection;

use BadMethodCallException;
use InvalidArgumentException;


trait Assertions
{
    /**
     * Ensure savepoint names are valid
     * @param string $name
     * @return void
     * @throws InvalidArgumentException
     */
    protected function assertName(string $name): void
    {
        if (strlen($name) == 0) {
            throw new InvalidArgumentException("Name cannot be empty");
        }
        if (strlen($name) > 255) {
            throw new InvalidArgumentException("Name must be less than 255 characters");
        }
        if (preg_match("/[^a-z0-9_-]/i", $name)) {
            throw new InvalidArgumentException(
                "Name can only contain ascii letters a-z, numbers 0-9, dash - and underscore _"
            );
        }
    }
    /**
     * Ensure a transaction is not in progress
     * @param ?string $msg The error message to throw
     * @return void
     * @throws BadMethodCallException
     */
    protected function assertNotInTransaction(?string $msg = "Cannot switch connections during a transaction"): void
    {
        if ($this->tx_level > 0) {
            throw new BadMethodCallException($msg);
        }
    }
}
